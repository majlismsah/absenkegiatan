<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Kehadiran QR Jamaah</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    .scanner-frame {
      width: 250px; height: 250px;
      border: 3px solid rgba(59, 130, 246, 0.5);
      border-radius: 12px;
      box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { border-color: rgba(59, 130, 246, 0.5); }
      50% { border-color: rgba(59, 130, 246, 0.8); }
    }
    .tab.active {
      background: linear-gradient(to right, #3b82f6, #8b5cf6);
      color: white;
    }
    .content-section { display: none; }
    .content-section.active { display: block; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4">
  <div class="mb-6 flex items-center gap-3">
    <img src="https://raw.githubusercontent.com/majlismsah/forminfaqkonsumsiashnaf/main/logo.png" class="w-12 h-12 rounded-full shadow" />
    <h1 class="text-2xl font-bold text-gray-800">QR Kehadiran Jamaah</h1>
  </div>

  <!-- Tab -->
  <div class="flex space-x-2 mb-6">
    <button class="tab active px-4 py-2 rounded-full font-medium" onclick="showTab('scanner')">Scanner</button>
    <button class="tab px-4 py-2 rounded-full font-medium" onclick="showTab('admin')">Admin Panel</button>
  </div>

  <!-- Scanner Section -->
  <div id="scanner" class="content-section active w-full max-w-md">
    <div class="bg-white p-4 rounded-xl shadow-lg">
      <div class="flex justify-between mb-2 text-sm text-gray-500">
        <div><i class="fas fa-users"></i> Hadir: <span id="attendanceCount">0</span></div>
        <div><i class="fas fa-clock"></i> <span id="currentTime">--:--:--</span></div>
      </div>
      <div class="relative">
        <div id="reader" class="rounded-xl overflow-hidden"></div>
        <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
          <div class="scanner-frame"></div>
        </div>
      </div>
      <button id="toggleCamera" class="mt-4 w-full bg-white border border-blue-600 text-blue-600 py-2 rounded-full font-medium hover:bg-blue-50">
        <i class="fas fa-camera-rotate"></i> Ganti Kamera
      </button>
    </div>
    <div id="hasil" class="mt-4"></div>
  </div>

  <!-- Admin Section -->
  <div id="admin" class="content-section w-full max-w-md">
    <div id="loginForm" class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-bold text-center mb-4">Admin Login</h2>
      <input id="username" class="w-full mb-3 p-2 border rounded" placeholder="Username" />
      <input id="password" class="w-full mb-3 p-2 border rounded" placeholder="Password" type="password" />
      <button onclick="loginAdmin()" class="w-full bg-blue-600 text-white py-2 rounded">Login</button>
    </div>
    <div id="adminPanel" class="hidden mt-6">
      <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-bold mb-2">Statistik Kehadiran</h3>
        <ul class="text-sm text-gray-700">
          <li>Total Hadir: <span id="totalScan">--</span></li>
          <li>Hari Ini: <span id="todayScan">--</span></li>
          <li>Terakhir Scan: <span id="lastScan">--</span></li>
        </ul>
        <button onclick="logoutAdmin()" class="mt-4 text-red-500">Logout</button>
      </div>
      <div id="riwayatScan" class="mt-4 space-y-3"></div>
    </div>
  </div>

  <!-- Suara -->
  <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="successSound" src="https://actions.google.com/sounds/v1/office/camera_shutter_click.ogg" preload="auto"></audio>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_warning.ogg" preload="auto"></audio>

  <script>
    const ADMIN_USER = 'admin';
    const ADMIN_PASS = '1234';
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyShqoa5Ed3ESuCwpWZcnCFIj1bjX6vuj1Td-FaF6F6Csr1nFogtfEsbDpTVxjxQtAPMA/exec';

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    function loginAdmin() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      if (u === ADMIN_USER && p === ADMIN_PASS) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        fetchAdminStats();
      } else {
        alert('Username atau password salah');
      }
    }

    function logoutAdmin() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function updateTime() {
      document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('id-ID');
    }
    setInterval(updateTime, 1000);
    updateTime();

    function speakName(nama) {
      const u = new SpeechSynthesisUtterance(nama);
      u.lang = 'id-ID';
      speechSynthesis.speak(u);
    }

    async function fetchAdminStats() {
      try {
        const res = await fetch(`${scriptURL}?mode=admin`);
        const data = await res.json();
        document.getElementById("totalScan").textContent = data.total;
        document.getElementById("todayScan").textContent = data.today;
        document.getElementById("lastScan").textContent = data.recent[0]?.waktu || '-';

        document.getElementById("riwayatScan").innerHTML = data.recent.map(entry => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div>
              <div class="font-medium">${entry.nama}</div>
              <div class="text-sm text-gray-500">Majlis ${entry.majlis}</div>
            </div>
            <div class="text-sm text-gray-500">${entry.waktu}</div>
          </div>`).join("");
      } catch (err) {
        console.error("Gagal ambil data admin:", err);
      }
    }
  </script>
  <!-- Footer -->
<footer class="mt-8">
  <p class="text-xs text-center text-gray-400">
    &copy; 2025 Sistem Kehadiran | Diselenggarakan oleh Majlis MSAH | Barakallahu fiikum
  </p>
</footer>
</body>
</html>
