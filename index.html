<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scan QR Jamaah - Sistem Kehadiran</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    .scanner-container {
      position: relative;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .scanner-frame {
      width: 250px;
      height: 250px;
      border: 3px solid rgba(59, 130, 246, 0.5);
      border-radius: 12px;
      box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { border-color: rgba(59, 130, 246, 0.5); }
      50% { border-color: rgba(59, 130, 246, 0.8); }
      100% { border-color: rgba(59, 130, 246, 0.5); }
    }
    
    .success-animation {
      animation: successFlash 1s;
    }
    
    @keyframes successFlash {
      0% { background-color: rgba(52, 211, 153, 0.1); }
      50% { background-color: rgba(52, 211, 153, 0.3); }
      100% { background-color: rgba(52, 211, 153, 0.1); }
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #3b82f6;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cooldown-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      border-radius: 12px;
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-start py-6 px-4">

  <!-- Header Section -->
  <header class="text-center mb-8 w-full max-w-md">
    <div class="flex items-center justify-center gap-3 mb-3">
      <div class="bg-blue-600 text-white p-3 rounded-full">
        <i class="fas fa-qrcode text-2xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Scan Kehadiran Jamaah</h1>
        <p class="text-sm text-gray-500">Arahkan kamera ke QR Code yang ditunjukkan jamaah</p>
      </div>
    </div>
    
    <div class="flex justify-center gap-2 mb-4">
      <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1">
        <i class="fas fa-users"></i>
        <span id="attendanceCount">0</span> Hadir
      </div>
      <div class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1">
        <i class="fas fa-clock"></i>
        <span id="currentTime">--:--:--</span>
      </div>
    </div>
  </header>

  <!-- Scanner Section -->
  <div class="w-full max-w-md mb-6">
    <div class="scanner-container bg-gray-100 shadow-xl rounded-2xl p-4 border border-gray-200 relative">
      <div id="reader" class="rounded-xl overflow-hidden relative"></div>
      <div class="scanner-overlay">
        <div class="scanner-frame"></div>
      </div>
      <div id="cooldownOverlay" class="cooldown-overlay hidden">
        <div class="text-xl mb-2">Tunggu sebentar</div>
        <div id="cooldownCounter" class="text-3xl">3</div>
        <div class="text-sm mt-2">Sebelum scan berikutnya</div>
      </div>
    </div>
    
    <div class="flex justify-center mt-4 gap-3">
      <button id="toggleCamera" class="bg-white text-blue-600 border border-blue-600 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-50 transition">
        <i class="fas fa-camera-rotate mr-1"></i> Ganti Kamera
      </button>
      <button id="toggleFlash" class="bg-white text-gray-600 border border-gray-600 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-50 transition">
        <i class="fas fa-lightbulb mr-1"></i> Lampu
      </button>
    </div>
  </div>

  <!-- Scan Results -->
  <div id="hasil" class="w-full max-w-md"></div>
  
  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="font-medium">Menyimpan data ke spreadsheet...</p>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="successSound" src="https://actions.google.com/sounds/v1/office/camera_shutter_click.ogg" preload="auto"></audio>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_warning.ogg" preload="auto"></audio>

  <script>
    // DOM Elements
    const beep = document.getElementById("beepSound");
    const successSound = document.getElementById("successSound");
    const errorSound = document.getElementById("errorSound");
    const hasil = document.getElementById("hasil");
    const toggleCameraBtn = document.getElementById("toggleCamera");
    const toggleFlashBtn = document.getElementById("toggleFlash");
    const attendanceCount = document.getElementById("attendanceCount");
    const currentTime = document.getElementById("currentTime");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const cooldownOverlay = document.getElementById("cooldownOverlay");
    const cooldownCounter = document.getElementById("cooldownCounter");
    
    // Google Sheets Configuration
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzlHocfxYefwWjiU4mDeO6q0A3abIQjqqAsfaPJawG4krkJmV2a4VBZbO0G2O6024z49Q/exec';
    const sheetName = 'Rekap';

    // Variables
    let html5QrCode;
    let currentCameraId = null;
    let cameras = [];
    let attendanceCounter = 0;
    let scanHistory = [];
    const SCAN_COOLDOWN = 3000; // 3 detik cooldown
    const DUPLICATE_TIMEOUT = 300000; // 5 menit batas duplikat
    
    // Update current time
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      currentTime.textContent = timeString;
      return now;
    }
    
    // Initialize time update
    setInterval(updateTime, 1000);
    updateTime();
    
    // Camera functions
    async function getCameras() {
      try {
        cameras = await Html5Qrcode.getCameras();
        if (cameras.length > 0) {
          currentCameraId = cameras[0].id;
          return true;
        }
        return false;
      } catch (error) {
        console.error("Error getting cameras:", error);
        showError("Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.");
        return false;
      }
    }
    
    async function startScanner(cameraId = null) {
      const config = { 
        fps: 5, // Lebih rendah untuk hindari scan berulang
        qrbox: { width: 250, height: 250 },
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        rememberLastUsedCamera: true,
        aspectRatio: 1.777778 // 16:9 aspect ratio
      };
      
      try {
        if (!cameraId) {
          cameraId = { facingMode: "environment" };
        }
        
        await html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);
        return true;
      } catch (error) {
        console.error("Error starting scanner:", error);
        showError("Gagal memulai scanner. Coba muat ulang halaman.");
        return false;
      }
    }
    
    async function toggleCamera() {
      if (cameras.length < 2) {
        showError("Hanya ditemukan 1 kamera");
        return;
      }
      
      try {
        await html5QrCode.stop();
        const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
        const nextIndex = (currentIndex + 1) % cameras.length;
        currentCameraId = cameras[nextIndex].id;
        await startScanner(currentCameraId);
        
        // Update button text
        const cameraLabel = cameras[nextIndex].label.toLowerCase();
        let cameraType = "Belakang";
        if (cameraLabel.includes("front")) {
          cameraType = "Depan";
        }
        toggleCameraBtn.innerHTML = `<i class="fas fa-camera-rotate mr-1"></i> Kamera ${cameraType}`;
      } catch (error) {
        console.error("Error toggling camera:", error);
      }
    }
    
    async function toggleFlash() {
      try {
        const track = html5QrCode.getRunningTrack();
        if (track && track.getCapabilities().torch) {
          await track.applyConstraints({
            advanced: [{torch: !track.getSettings().torch}]
          });
          toggleFlashBtn.classList.toggle("text-yellow-500");
          toggleFlashBtn.classList.toggle("border-yellow-500");
        } else {
          showError("Lampu flash tidak tersedia");
        }
      } catch (error) {
        console.error("Error toggling flash:", error);
      }
    }
    
    // Function to show cooldown
    function showCooldown(seconds) {
      cooldownOverlay.classList.remove("hidden");
      let counter = seconds;
      
      const interval = setInterval(() => {
        cooldownCounter.textContent = counter;
        counter--;
        
        if (counter < 0) {
          clearInterval(interval);
          cooldownOverlay.classList.add("hidden");
        }
      }, 1000);
    }
    
    // Function to send data to Google Sheets
    async function sendToGoogleSheets(data) {
  loadingIndicator.classList.remove("hidden");
  
  try {
    const now = new Date();
    
    // Create URL parameters
    const params = new URLSearchParams();
    params.append('nama_jamaah', data.nama_jamaah || '-');
    params.append('majlis', data.majlis || '-');
    params.append('status', 'Hadir');
    params.append('sheet_name', sheetName);
    
    // Coba metode POST dulu, jika gagal gunakan GET
    try {
      // Try POST method first
      const response = await fetch(scriptURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString(),
        mode: 'cors'
      });
      
      if (!response.ok) throw new Error('POST failed, trying GET');
      
      const result = await response.json();
      if (result.result !== "success") throw new Error(result.message);
      
    } catch (postError) {
      console.log('Trying GET method:', postError);
      // Fallback to GET method
      const getResponse = await fetch(`${scriptURL}?${params.toString()}`, {
        method: 'GET',
        redirect: 'follow',
        mode: 'cors'
      });
      
      if (!getResponse.ok) throw new Error('GET request failed');
      
      // Handle redirect if any
      const finalUrl = getResponse.url;
      if (finalUrl.includes('https://script.google.com')) {
        const redirectedResponse = await fetch(finalUrl, {
          method: 'GET',
          mode: 'cors'
        });
        if (!redirectedResponse.ok) throw new Error('Redirect failed');
      }
    }
    
    // Update UI
    attendanceCounter++;
    attendanceCount.textContent = attendanceCounter;
    
    hasil.innerHTML = `
      <div class="success-animation p-4 bg-green-50 border border-green-200 rounded-xl shadow-sm max-w-md mx-auto mb-3">
        <div class="flex items-start gap-3">
          <div class="bg-green-100 text-green-800 p-2 rounded-full">
            <i class="fas fa-check"></i>
          </div>
          <div>
            <h3 class="font-bold text-green-800">Data Tersimpan!</h3>
            <p class="text-sm text-gray-600 mt-1">${data.nama_jamaah} - ${data.majlis}</p>
            <div class="mt-2 text-xs text-gray-500 flex items-center gap-1">
              <i class="far fa-clock"></i> ${now.toLocaleTimeString('id-ID')}
            </div>
          </div>
        </div>
      </div>`;
      
  } catch (error) {
    console.error("Error saving to Google Sheets:", error);
    showError(`Gagal menyimpan data: ${error.message}`);
  } finally {
    loadingIndicator.classList.add("hidden");
  }
}
    
    // Scan handlers
    function onScanSuccess(decodedText, decodedResult) {
      const now = Date.now();
      
      // Cek duplikat dalam 5 menit terakhir
      const isDuplicate = scanHistory.some(scan => 
        scan.text === decodedText && (now - scan.time) < DUPLICATE_TIMEOUT
      );
      
      if (isDuplicate) {
        errorSound.play().catch(e => console.log("Audio play error:", e));
        showError("Data ini sudah discan dalam 5 menit terakhir");
        return;
      }
      
      // Play success sound
      beep.play().catch(e => console.log("Audio play error:", e));
      successSound.play().catch(e => console.log("Audio play error:", e));
      
      // Tambahkan ke history scan
      scanHistory.push({
        text: decodedText,
        time: now
      });
      
      // Bersihkan history yang sudah lewat timeout
      scanHistory = scanHistory.filter(scan => (now - scan.time) < DUPLICATE_TIMEOUT);
      
      // Parse QR data (format: "Nama|Majlis")
      const [nama_jamaah, majlis] = decodedText.split("|");
      
      // Prepare data for Google Sheets
      const data = {
        nama_jamaah: nama_jamaah || decodedText,
        majlis: majlis || '-'
      };
      
      // Kirim data
      sendToGoogleSheets(data);
      
      // Pause scanner dan tampilkan cooldown
      html5QrCode.pause();
      showCooldown(3);
      
      // Aktifkan kembali setelah cooldown
      setTimeout(() => {
        html5QrCode.resume();
      }, SCAN_COOLDOWN);
    }
    
    function onScanFailure(error) {
      console.log("Scan error:", error);
    }
    
    function showError(message) {
      hasil.innerHTML = `
        <div class="p-4 bg-red-50 border border-red-200 rounded-xl shadow-sm max-w-md mx-auto mb-3">
          <div class="flex items-start gap-3">
            <div class="bg-red-100 text-red-800 p-2 rounded-full">
              <i class="fas fa-exclamation"></i>
            </div>
            <div>
              <h3 class="font-bold text-red-800">Terjadi Kesalahan</h3>
              <p class="text-sm text-gray-600 mt-1">${message}</p>
            </div>
          </div>
        </div>`;
    }
    
    // Initialize scanner
    async function initScanner() {
      html5QrCode = new Html5Qrcode("reader");
      
      if (await getCameras()) {
        await startScanner(currentCameraId);
      }
    }
    
    // Event listeners
    toggleCameraBtn.addEventListener("click", toggleCamera);
    toggleFlashBtn.addEventListener("click", toggleFlash);
    
    // Initialize
    document.addEventListener("DOMContentLoaded", initScanner);
  </script>
</body>
</html>
