<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scan QR Jamaah - Sistem Kehadiran</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .scanner-container { position: relative; }
    .scanner-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center; pointer-events: none;
    }
    .scanner-frame {
      width: 250px; height: 250px;
      border: 3px solid rgba(59, 130, 246, 0.5);
      border-radius: 12px;
      box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { border-color: rgba(59, 130, 246, 0.5); }
      50% { border-color: rgba(59, 130, 246, 0.8); }
      100% { border-color: rgba(59, 130, 246, 0.5); }
    }
    .success-animation { animation: successFlash 1s; }
    @keyframes successFlash {
      0% { background-color: rgba(52, 211, 153, 0.1); }
      50% { background-color: rgba(52, 211, 153, 0.3); }
      100% { background-color: rgba(52, 211, 153, 0.1); }
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #3b82f6;
      width: 20px; height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-start py-6 px-4">
  <!-- UI omitted for brevity -->

  <script>
    const beep = document.getElementById("beepSound");
    const successSound = document.getElementById("successSound");
    const hasil = document.getElementById("hasil");
    const toggleCameraBtn = document.getElementById("toggleCamera");
    const toggleFlashBtn = document.getElementById("toggleFlash");
    const attendanceCount = document.getElementById("attendanceCount");
    const currentTime = document.getElementById("currentTime");
    const loadingIndicator = document.getElementById("loadingIndicator");

    const scriptURL = 'https://script.google.com/macros/s/AKfycbw51UHEYJ1OO5J_pIvf7zHtUFcmIQME5mo46bXM1Qyh2Ut43gX18PU8lO2P5wao-LeTlA/exec';
    const sheetName = 'Rekap';

    let html5QrCode;
    let currentCameraId = null;
    let cameras = [];
    let attendanceCounter = 0;
    let lastScannedText = "";
    let lastScanTime = 0;

    function updateTime() {
      const now = new Date();
      currentTime.textContent = now.toLocaleTimeString('id-ID', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    setInterval(updateTime, 1000);
    updateTime();

    async function getCameras() {
      try {
        cameras = await Html5Qrcode.getCameras();
        if (cameras.length > 0) {
          currentCameraId = cameras[0].id;
          return true;
        }
        return false;
      } catch (error) {
        console.error("Error getting cameras:", error);
        showError("Tidak dapat mengakses kamera.");
        return false;
      }
    }

    async function startScanner(cameraId = null) {
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };
      try {
        await html5QrCode.start(cameraId || { facingMode: "environment" }, config, onScanSuccess, onScanFailure);
      } catch (error) {
        console.error("Start scanner error:", error);
        showError("Gagal memulai scanner.");
      }
    }

    async function toggleCamera() {
      if (cameras.length < 2) return showError("Hanya ditemukan 1 kamera");
      try {
        await html5QrCode.stop();
        const idx = (cameras.findIndex(cam => cam.id === currentCameraId) + 1) % cameras.length;
        currentCameraId = cameras[idx].id;
        await startScanner(currentCameraId);
      } catch (e) { console.error("Toggle camera error:", e); }
    }

    async function toggleFlash() {
      try {
        const track = html5QrCode.getRunningTrack();
        if (track && track.getCapabilities().torch) {
          await track.applyConstraints({ advanced: [{ torch: !track.getSettings().torch }] });
          toggleFlashBtn.classList.toggle("text-yellow-500");
        } else {
          showError("Lampu flash tidak tersedia");
        }
      } catch (e) {
        console.error("Toggle flash error:", e);
      }
    }

    async function sendToGoogleSheets(data) {
      loadingIndicator.classList.remove("hidden");
      try {
        const now = new Date();
        const params = new URLSearchParams({
          nama_jamaah: data.nama_jamaah || '-',
          majlis: data.majlis || '-',
          status: 'Hadir',
          sheet_name: sheetName
        });
        await fetch(`${scriptURL}?${params.toString()}`, { method: 'GET' });
        attendanceCounter++;
        attendanceCount.textContent = attendanceCounter;
        hasil.innerHTML = `<div class="success-animation p-4 bg-green-50 border border-green-200 rounded-xl">
            <div class="flex gap-3"><div class="bg-green-100 p-2 rounded-full text-green-800"><i class="fas fa-check"></i></div>
              <div><h3 class="font-bold text-green-800">Data Tersimpan!</h3>
              <p class="text-sm">${data.nama_jamaah} - ${data.majlis}</p>
              <div class="text-xs text-gray-500 flex gap-1"><i class="far fa-clock"></i> ${now.toLocaleTimeString('id-ID')}</div></div>
            </div></div>`;
      } catch (e) {
        console.error("Send error:", e);
        showError("Gagal menyimpan data.");
      } finally {
        loadingIndicator.classList.add("hidden");
      }
    }

    function onScanSuccess(decodedText) {
      const now = Date.now();
      if (decodedText === lastScannedText && (now - lastScanTime) < 5000) return;
      lastScannedText = decodedText;
      lastScanTime = now;

      beep.play().catch(() => {});
      successSound.play().catch(() => {});

      const [nama_jamaah, majlis] = decodedText.split("|");
      const data = { nama_jamaah: nama_jamaah || decodedText, majlis: majlis || '-' };
      sendToGoogleSheets(data);
    }

    function onScanFailure(error) {
      console.log("Scan error:", error);
    }

    function showError(message) {
      hasil.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-xl">
        <div class="flex gap-3">
          <div class="bg-red-100 text-red-800 p-2 rounded-full"><i class="fas fa-exclamation"></i></div>
          <div><h3 class="font-bold text-red-800">Terjadi Kesalahan</h3><p class="text-sm">${message}</p></div>
        </div></div>`;
    }

    async function initScanner() {
      html5QrCode = new Html5Qrcode("reader");
      if (await getCameras()) await startScanner(currentCameraId);
    }

    toggleCameraBtn.addEventListener("click", toggleCamera);
    toggleFlashBtn.addEventListener("click", toggleFlash);
    document.addEventListener("DOMContentLoaded", initScanner);
  </script>
</body>
</html>
